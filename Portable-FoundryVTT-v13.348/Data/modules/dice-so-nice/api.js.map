{"version":3,"file":"api.js","sources":["../module/DiceSystem.js","../module/DiceSFX.js"],"sourcesContent":["export class DiceSystem {\n\n    //setting scoping is currently useless as there's no good way for the user to set a \"local\" setting if they are not using this dice set\n    //keeping this for future use\n    static SETTING_SCOPE = {\n        LOCAL: 0, // User specific settings that is not shared with other players\n        SHARED: 1 // User specific settings that is shared with other players\n    }\n\n    static SETTING_TYPE = {\n        BOOLEAN: \"boolean\",\n        SELECT: \"select\",\n        COLOR: \"color\",\n        FILE: \"file\",\n        RANGE: \"range\",\n        STRING: \"string\"\n    }\n\n    static SETTING_FORMATING = {\n        SEPARATOR: \"separator\",\n        HTML: \"html\"\n    }\n\n    static DICE_EVENT_TYPE = {\n        SPAWN: 0,\n        CLICK: 1,\n        RESULT: 2,\n        COLLIDE: 3, //not implemented, risk of performance impact \n        DESPAWN: 4 //not implemented. need a use-case. \"result\" seems to be the enough for despawning animations\n    }\n\n    static generateHash = (str) => {\n        let hash = 0,\n            i, chr;\n        if (str.length === 0) return hash;\n        for (i = 0; i < str.length; i++) {\n            chr = str.charCodeAt(i);\n            hash = ((hash << 5) - hash) + chr;\n            hash |= 0;\n        }\n        return hash;\n    }\n\n    /**\n     * Creates a new instance of the DiceSystem class.\n     *\n     * @param {string} id - The unique identifier for the dice system.\n     * @param {string} name - The name of the dice system.\n     * @param {Map} [dice=null] - A map of dice for the dice system.\n     * @param {string} [mode=\"default\"] - The mode of the dice system.\n     * @param {string|null} [group=null] - The group the dice system belongs to.\n     */\n    constructor(id, name, mode = \"default\", group = null) {\n        this._id = id;\n        this._name = name;\n        this._dice = new DiceMap(this);\n        this._mode = mode;\n        this._group = group;\n\n        this._settings = [];\n        this._scopedSettings = new Map();\n\n        this._listeners = [];\n\n        this._registeredProcessMaterialCallbacks = [];\n        this._registeredBeforeShaderCompileCallbacks = [];\n    }\n\n    get id() {\n        return this._id;\n    }\n\n    get name() {\n        return this._name;\n    }\n\n    get dice() {\n        return this._dice;\n    }\n\n    get mode() {\n        return this._mode;\n    }\n\n    get group() {\n        return this._group;\n    }\n\n    get settings() {\n        const objValues = Object.values(DiceSystem.SETTING_TYPE);\n        return this._settings.filter((setting) => objValues.includes(setting.type));\n    }\n\n    on(eventType, listener) {\n        if(!Object.values(DiceSystem.DICE_EVENT_TYPE).includes(eventType))\n            throw new Error(`[DiceSystem.fire] Invalid dice event type: ${eventType}`);\n\n        if (!this._listeners[eventType]) {\n            this._listeners[eventType] = [];\n        }\n        this._listeners[eventType].push(listener);\n    }\n\n    off(eventType, listener) {\n        if (!this._listeners[eventType]) return;\n\n        const index = this._listeners[eventType].indexOf(listener);\n        if (index > -1) {\n            this._listeners[eventType].splice(index, 1);\n        }\n    }\n\n    fire(eventType, event) {\n        if(!Object.values(DiceSystem.DICE_EVENT_TYPE).includes(eventType))\n            throw new Error(`[DiceSystem.fire] Invalid dice event type: ${eventType}`);\n\n        this._dispatchEvent(eventType, event);\n    }\n\n    _dispatchEvent(eventType, event) {\n        if (!this._listeners[eventType]) return;\n\n        for (const listener of this._listeners[eventType]) {\n            listener(event);\n        }\n    }\n\n    getSettingsByDiceType(diceType) {\n        return this._scopedSettings.get(diceType) || this._scopedSettings.get(\"global\");\n    }\n\n    getCacheString(appearance) {\n        return this.id+JSON.stringify(Object.values(appearance));\n    }\n\n    processMaterial(diceType, material, appearance) {\n        if(this.dice.has(diceType)) {\n            for(const callback of this._registeredProcessMaterialCallbacks) {\n                callback(diceType, material, appearance);\n            }\n\n            material.userData.diceType = diceType;\n            material.userData.system = this.id;\n            material.userData.appearance = appearance;\n        }\n        return material;\n    }\n\n    beforeShaderCompile(shader, material) {\n        let fragmentShader = shader.fragmentShader;\n        let vertexShader = shader.vertexShader;\n \n        for(const callback of this._registeredBeforeShaderCompileCallbacks) {\n            callback(shader, material, material.userData.diceType, material.userData.appearance);\n        }\n\n        material.userData.shaderCacheKey = DiceSystem.generateHash(shader.fragmentShader+shader.vertexShader);\n\n        if(fragmentShader != shader.fragmentShader || vertexShader != shader.vertexShader) {\n            material.customProgramCacheKey = () => {\n                return material.userData.shaderCacheKey;\n            }\n            material.needsUpdate = true;\n        }\n    }\n\n    /**\n     * Registers a callback to be called when a material is processed for a dice of this system.\n     * The callback will be called with the diceType, material and appearance as arguments.\n     * @param {function} callback - The callback to be called.\n     */\n    registerProcessMaterialCallback(callback) {\n        this._registeredProcessMaterialCallbacks.push(callback);\n    }\n    \n    /**\n     * Registers a callback to be called when a shader is compiled for a dice of this system.\n     * The callback will be called with the shader, material and appearance as arguments.\n     * @param {function} callback - The callback to be called.\n     */\n    registerBeforeShaderCompileCallback(callback) {\n        this._registeredBeforeShaderCompileCallbacks.push(callback);\n    }\n\n    updateSettings(diceType = \"global\", settings) {\n        this._scopedSettings.set(diceType, {...settings});\n    }\n\n    loadSettings() {\n        this._scopedSettings = new Map();\n        //called after the system is added to the dice factory\n        //check for saved settings and load them\n        const savedSettings = game.user.getFlag(\"dice-so-nice\", \"appearance\");\n\n        //set default settings (just key/value pairs)\n        const defaultSettings = this.settings.reduce((acc, { id, defaultValue }) => ({ ...acc, [id]: defaultValue }), {});\n        this._scopedSettings.set(\"global\", defaultSettings);\n\n        if(savedSettings) {\n            for(let diceType of Object.keys(savedSettings)) {\n                if(savedSettings[diceType].system === this.id) {\n                    this._scopedSettings.set(diceType, {...savedSettings[diceType].systemSettings});\n                }\n            }\n        }\n    }\n\n    /**\n     * Creates a setting object with the specified type, id, name, scope, value, and additional properties.\n     *\n     * @param {string} type - The type of the setting.\n     * @param {string} id - The unique identifier of the setting.\n     * @param {string} name - The name of the setting.\n     * @param {string} scope - The scope of the setting.\n     * @param {any} value - The value of the setting.\n     * @param {Object} [additionalProperties={}] - Additional properties to be added to the setting object.\n     * @return {Object} The created setting object.\n     */\n    _createSetting(type, id, name, scope, defaultValue, additionalProperties = {}) {\n        //field checks\n        if (!Object.values(DiceSystem.SETTING_TYPE).includes(type) && !Object.values(DiceSystem.SETTING_FORMATING).includes(type)) {\n            throw new Error(`[DiceSystem._createSetting] Invalid setting type: ${type}`);\n        }\n\n        if (!Object.values(DiceSystem.SETTING_SCOPE).includes(scope) && !Object.values(DiceSystem.SETTING_SCOPE).includes(scope)) {\n            throw new Error(`[DiceSystem._createSetting] Invalid setting scope: ${scope}`);\n        }\n\n        if (DiceSystem.SETTING_TYPE.hasOwnProperty(type)) {\n            if (!id) {\n                throw new Error(`[DiceSystem._createSetting] Invalid setting id: ${id}`);\n            }\n\n            if (!name) {\n                throw new Error(`[DiceSystem._createSetting] Invalid setting name: ${name}`);\n            }\n        }\n\n        this._settings.push({\n            type,\n            id,\n            name,\n            defaultValue,\n            scope: scope,\n            ...additionalProperties\n        });\n    }\n\n    /**\n     * Adds a visual separator with an optional title.\n     *\n     * @param {Object} args - The options for the separator.\n     * @param {string} [args.name=\"\"] - The title to display\n     * @return {void}\n     */\n    addSettingSeparator({ name = \"\" } = {}) {\n        this._createSetting(\"separator\", null, name, DiceSystem.SETTING_SCOPE.LOCAL, null);\n    }\n\n    addSettingHTML({ name }) {\n        this._createSetting(\"html\", null, name, DiceSystem.SETTING_SCOPE.LOCAL, null);\n    }\n\n    /**\n     * Adds a boolean setting\n     *\n     * @param {Object} args - The arguments object.\n     * @param {string} args.id - The unique identifier for the setting.\n     * @param {string} args.name - The name of the setting.\n     * @param {string} args.scope - The scope of the setting.\n     * @param {boolean} [args.defaultValue=false] - The default value of the setting.\n     * @return {void}\n     */\n    addSettingBoolean({ id, name, scope = DiceSystem.SETTING_SCOPE.SHARED, defaultValue = false }) {\n        this._createSetting(\"boolean\", id, name, scope, defaultValue);\n    }\n\n    /**\n     * Adds a color setting\n     *\n     * @param {Object} args - The arguments object.\n     * @param {string} args.id - The unique identifier for the setting.\n     * @param {string} args.name - The name of the setting.\n     * @param {string} args.scope - The scope of the setting.\n     * @param {string} [args.defaultValue=null] - The default value of the setting, in hex format, e.g. \"#ffffff\".\n     * @return {void}\n     */\n    addSettingColor({ id, name, scope = DiceSystem.SETTING_SCOPE.SHARED, defaultValue = \"#ffffff\" }) {\n        this._createSetting(\"color\", id, name, scope, defaultValue);\n    }\n\n    /**\n     * Adds a range setting\n     *\n     * @param {Object} args - The arguments object.\n     * @param {string} args.id - The unique identifier for the setting.\n     * @param {string} args.name - The name of the setting.\n     * @param {string} args.scope - The scope of the setting.\n     * @param {number} [args.defaultValue=0] - The default value of the setting.\n     * @param {number} [args.min=0] - The minimum value of the setting.\n     * @param {number} [args.max=100] - The maximum value of the setting.\n     * @param {number} [args.step=1] - The step value of the setting.\n     * @return {void}\n     */\n    addSettingRange({ id, name, scope = DiceSystem.SETTING_SCOPE.SHARED, defaultValue = 0, min = 0, max = 100, step = 1 }) {\n        this._createSetting(\"range\", id, name, scope, defaultValue, { min, max, step });\n    }\n\n    /**\n     * Adds a file setting\n     *\n     * @param {Object} args - The arguments object.\n     * @param {string} args.id - The unique identifier for the setting.\n     * @param {string} args.name - The name of the setting.\n     * @param {string} args.scope - The scope of the setting.\n     * @param {string|null} [args.defaultValue=null] - The default value of the setting.\n     * @return {void}\n     */\n    addSettingFile({ id, name, scope = DiceSystem.SETTING_SCOPE.SHARED, defaultValue = \"\" }) {\n        // Make sure defaultValue is a string)\n        defaultValue = defaultValue || \"\";\n        this._createSetting(\"file\", id, name, scope, defaultValue);\n    }\n\n    /**\n     * Adds a select setting\n     *\n     * @param {Object} args - The arguments object.\n     * @param {string} args.id - The unique identifier for the setting.\n     * @param {string} args.name - The name of the setting.\n     * @param {string} args.scope - The scope of the setting.\n     * @param {string|null} [args.defaultValue=null] - The default value of the setting.\n     * @param {Object} [args.options={}] - The options for the select setting.\n     * @param {string} args.options.id - The unique identifier for the option.\n     * @param {string} args.options.label - The label for the option.\n     * @param {string} [args.options.group=null] - The group for the option.\n     * @return {void}\n     */\n    addSettingSelect({ id, name, scope = DiceSystem.SETTING_SCOPE.SHARED, defaultValue = null, options = {} }) {\n        this._createSetting(\"select\", id, name, scope, defaultValue, { options });\n    }\n\n    /**\n     * Adds a string setting.\n     *\n     * @param {Object} options - The options for the setting.\n     * @param {string} options.id - The unique identifier for the setting.\n     * @param {string} options.name - The name of the setting.\n     * @param {string} options.scope - The scope of the setting.\n     * @param {string|null} [options.defaultValue=null] - The default value of the setting.\n     * @return {void}\n     */\n    addSettingString({ id, name, scope = DiceSystem.SETTING_SCOPE.SHARED, defaultValue = \"\" }) {\n        // Make sure defaultValue is a string\n        defaultValue = defaultValue || \"\";\n        this._createSetting(\"string\", id, name, scope, defaultValue);\n    }\n\n    /**\n     * Retrieves a dice object from the dice array based on the given shape and values.\n     *\n     * @param {string} shape - The shape of the dice.\n     * @param {Array} values - The values of the dice.\n     * @return {Object|null} The dice object if found, or null if not found.\n     */\n    getDiceByShapeAndValues(shape, values) {\n        for (let dice of this.dice.values()) {\n            if (dice.shape == shape && dice.values.length == values.length) {\n                return dice;\n            }\n        }\n        return null;\n    }\n\n    /**\n     * Retrieves the value of a scoped setting for a specific dice type.\n     *\n     * @param {string} diceType - The type of the dice.\n     * @param {string} settingId - The ID of the setting.\n     * @return {any} The value of the scoped setting, or the default value if not found.\n     */\n    getScopedSettingValue(diceType, settingId) {\n        return this._scopedSettings.get(diceType)?.[settingId] ?? this._scopedSettings.get(\"global\")?.[settingId];\n    }\n\n    /**\n     * Generates the HTML content and data for a settings dialog line based on the provided setting.\n     *\n     * @param {Object} setting - The setting object containing the type, id, name, and value.\n     * @param {string} diceType - The type of the dice or \"global\"\n     * @return {Object} An object containing the HTML content and data for the settings dialog line.\n     */\n    getSettingsDialogLine(setting, diceType) {\n        let line = {\n            content: \"\",\n            data: {}\n        };\n        switch (setting.type) {\n            case DiceSystem.SETTING_TYPE.BOOLEAN:\n                line.content = `\n                    <div class=\"form-group\">\n                        <label>${setting.name}</label>\n                        <div class=\"form-fields\">\n                            <input type=\"checkbox\" name=\"appearance[${diceType}][systemSettings][${setting.id}]\" data-dtype=\"Boolean\" {{checked ${setting.id}.value}} />\n                        </div>\n                    </div>\n                `;\n\n                line.data = {\n                    value: this.getScopedSettingValue(diceType, setting.id)\n                };\n                break;\n            case DiceSystem.SETTING_TYPE.STRING:\n                line.content = `\n                    <div class=\"form-group\">\n                        <label>${setting.name}</label>\n                        <div class=\"form-fields\">\n                            <input type=\"text\" name=\"appearance[${diceType}][systemSettings][${setting.id}]\" value=\"{{${setting.id}.value}}\" data-dtype=\"String\" />\n                        </div>\n                    </div>\n                `;\n\n                line.data = {\n                    value: this.getScopedSettingValue(diceType, setting.id)\n                };\n                break;\n            case DiceSystem.SETTING_TYPE.COLOR:\n                line.content = `\n                    <div class=\"form-group\">\n                        <label>${setting.name}</label>\n                        <div class=\"form-fields\">\n                            <input type=\"text\" data-colorpicker name=\"appearance[${diceType}][systemSettings][${setting.id}]\" value=\"{{${setting.id}.value}}\" data-dtype=\"String\" />\n                            <input type=\"color\" name=\"appearance[${diceType}][systemSettings][${setting.id}Selector]\" value=\"{{${setting.id}.value}}\"\n                                data-edit=\"appearance[${diceType}][systemSettings][${setting.id}]\" data-${setting.id}Selector />\n                        </div>\n                    </div>\n                `;\n\n                line.data = {\n                    value: this.getScopedSettingValue(diceType, setting.id)\n                };\n                break;\n            case DiceSystem.SETTING_TYPE.RANGE:\n                line.content = `\n                    <div class=\"form-group\">\n                        <label>${setting.name}</label>\n                        <div class=\"form-fields\">\n                            <input type=\"range\" name=\"appearance[${diceType}][systemSettings][${setting.id}]\" value=\"{{${setting.id}.value}}\" min=\"{{${setting.id}.min}}\" max=\"{{${setting.id}.max}}\" step=\"{{${setting.id}.step}}\" data-dtype=\"Number\">\n                            <span class=\"range-value\">{{${setting.id}.value}}</span>\n                        </div>\n                    </div>\n                `;\n\n                line.data = {\n                    value: this.getScopedSettingValue(diceType, setting.id),\n                    min: setting.min,\n                    max: setting.max,\n                    step: setting.step\n                };\n                break;\n            case DiceSystem.SETTING_TYPE.FILE:\n                line.content = `\n                    <div class=\"form-group\">\n                        <label>${setting.name}</label>\n                        <div class=\"form-fields\">\n                            <input type=\"file\" name=\"appearance[${diceType}][systemSettings][${setting.id}]\" value=\"{{${setting.id}.value}}\"\n                                data-edit=\"appearance[${diceType}][systemSettings][${setting.id}]\" data-${setting.id} />\n                        </div>\n                    </div>\n                `;\n\n                line.data = {\n                    value: this.getScopedSettingValue(diceType, setting.id)\n                };\n                break;\n            case DiceSystem.SETTING_TYPE.SELECT:\n                line.content = `\n                    <div class=\"form-group\">\n                        <label>${setting.name}</label>\n                        <div class=\"form-fields\">\n                            <select name=\"appearance[${diceType}][systemSettings][${setting.id}]\" data-dtype=\"String\">\n                                {{selectOptions ${setting.id}.options selected=${setting.id}.value}}\n                            </select>\n                        </div>\n                    </div>\n                `;\n\n                line.data = {\n                    value: this.getScopedSettingValue(diceType, setting.id),\n                    options: setting.options\n                };\n                break;\n            case DiceSystem.SETTING_FORMATING.SEPARATOR:\n                if (setting.name != \"\")\n                    line.content = `<h2>${setting.name}</h2>`;\n                else\n                    line.content = `<hr />`;\n                break;\n            case DiceSystem.SETTING_FORMATING.HTML:\n                line.content = setting.name;\n                break;\n        }\n\n        return line;\n    }\n\n    getSettingsDialogContent(diceType) {\n        let dialogContent = {\n            content: \"\",\n            data: {}\n        };\n\n        if (!this._settings.length) return dialogContent;\n\n        // generate the content and data for each setting\n        for (let setting of this._settings) {\n            let line = this.getSettingsDialogLine(setting, diceType);\n            dialogContent.content += line.content;\n            dialogContent.data[setting.id] = line.data;\n        }\n\n        dialogContent.content = `<div data-systemSettings=\"${this.id}\">${dialogContent.content}</div>`;\n\n        return dialogContent;\n    }\n\n    getDefaultSettings() {\n        let settings = this.settings;\n        let defaultSettings = {};\n\n        for (let setting of settings) {\n            defaultSettings[setting.id] = setting.defaultValue;\n        }\n\n        return defaultSettings;\n    }\n}\n\nclass DiceMap extends Map {\n    constructor(diceSystem, ...args) {\n        super(...args);\n        this._diceSystem = diceSystem;\n    }\n    set(key, value) {\n        if (!this.has(key)) {\n            // Set the DiceSystem object as the value of value.diceSystem\n            value.diceSystem = this._diceSystem;\n        }\n        return super.set(key, value);\n    }\n}\n","export class DiceSFX {\n    // Whether this SFX should only be played once per logical dice (even if represented by multiple meshes, e.g., percentile dice)\n    static PLAY_ONLY_ONCE_PER_MESH = false;\n    get nameLocalized(){\n        return game.i18n.localize(this._name);\n    }\n    \n    constructor(box, dicemesh, options){\n        const defaultOptions = {\n            isGlobal : false,\n            muteSound : false\n        };\n\n        this.options = foundry.utils.mergeObject(defaultOptions, options);\n\n        this.dicemesh = dicemesh;\n        this.box = box;\n        this.destroyed = false;\n        this.enableGC = false;\n        this.renderReady = false;\n        this.volume = (dicemesh.options.secretRoll && box.muteSoundSecretRolls) || this.options.muteSound ? 0 : this.box.volume;\n    }\n\n    static async init(){\n        return true;\n    }\n\n    computeScale(){\n        let scale = this.box.dicefactory.baseScale / 100;\n        switch (this.dicemesh.shape) {\n            case \"d2\":\n                scale *= 1.3;\n                break;\n            case \"d4\":\n                scale *= 1.1;\n                break;\n            case \"d6\":\n                break;\n            case \"d8\":\n                scale *= 1.1;\n                break;\n            case \"d10\":\n                break;\n            case \"d12\":\n                scale *= 1.2;\n                break;\n            case \"d20\":\n                scale *= 1.3;\n                break;\n        }\n        return scale;\n    }\n\n    async play(){\n        return Promise.resolve();\n    }\n\n    static async loadAsset(loader,url) {\n        return new Promise((resolve, reject) => {\n          loader.load(url, data=> resolve(data), null, reject);\n        });\n    }\n\n    static getDialogContent(sfxLine,id){\n        let dialogContent = {};\n        let disabled = game.user.isGM ? '':'disabled=\"disabled\"';\n        dialogContent.content = `<div class=\"form-group\">\n                                    <label>{{localize \"DICESONICE.sfxOptionsIsGlobal\"}}</label>\n                                    <div class=\"form-fields\">\n                                        <input type=\"checkbox\" name=\"sfxLine[{{id}}][options][isGlobal]\" data-dtype=\"Boolean\" ${disabled} {{checked isGlobal}} />\n                                    </div>\n                                </div>\n                                <div class=\"form-group\">\n                                    <label>{{localize \"DICESONICE.sfxOptionsMuteSound\"}}</label>\n                                    <div class=\"form-fields\">\n                                        <input type=\"checkbox\" name=\"sfxLine[{{id}}][options][muteSound]\" data-dtype=\"Boolean\" ${disabled} {{checked muteSound}} />\n                                    </div>\n                                </div>`;\n\n        dialogContent.data = {\n            isGlobal : sfxLine.options ? sfxLine.options.isGlobal:false,\n            muteSound : sfxLine.options ? sfxLine.options.muteSound:false,\n            id:id\n        };\n\n        return dialogContent;\n    }\n}"],"names":["DiceSystem","static","LOCAL","SHARED","BOOLEAN","SELECT","COLOR","FILE","RANGE","STRING","SEPARATOR","HTML","SPAWN","CLICK","RESULT","COLLIDE","DESPAWN","str","i","chr","hash","length","charCodeAt","constructor","id","name","mode","group","this","_id","_name","_dice","DiceMap","_mode","_group","_settings","_scopedSettings","Map","_listeners","_registeredProcessMaterialCallbacks","_registeredBeforeShaderCompileCallbacks","dice","settings","objValues","Object","values","SETTING_TYPE","filter","setting","includes","type","on","eventType","listener","DICE_EVENT_TYPE","Error","push","off","index","indexOf","splice","fire","event","_dispatchEvent","getSettingsByDiceType","diceType","get","getCacheString","appearance","JSON","stringify","processMaterial","material","has","callback","userData","system","beforeShaderCompile","shader","fragmentShader","vertexShader","shaderCacheKey","generateHash","customProgramCacheKey","needsUpdate","registerProcessMaterialCallback","registerBeforeShaderCompileCallback","updateSettings","set","loadSettings","savedSettings","game","user","getFlag","defaultSettings","reduce","acc","defaultValue","keys","systemSettings","_createSetting","scope","additionalProperties","SETTING_FORMATING","SETTING_SCOPE","hasOwnProperty","addSettingSeparator","addSettingHTML","addSettingBoolean","addSettingColor","addSettingRange","min","max","step","addSettingFile","addSettingSelect","options","addSettingString","getDiceByShapeAndValues","shape","getScopedSettingValue","settingId","getSettingsDialogLine","line","content","data","value","getSettingsDialogContent","dialogContent","getDefaultSettings","diceSystem","args","super","_diceSystem","key","DiceSFX","nameLocalized","i18n","localize","box","dicemesh","foundry","utils","mergeObject","isGlobal","muteSound","destroyed","enableGC","renderReady","volume","secretRoll","muteSoundSecretRolls","init","computeScale","scale","dicefactory","baseScale","play","Promise","resolve","loadAsset","loader","url","reject","load","getDialogContent","sfxLine","disabled","isGM"],"mappings":"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"}